{%- liquid
  assign enough_to_wrap = false
  if section.blocks.size > 1
    assign enough_to_wrap = true
  endif
-%}

{% capture carousel_config %}{
  "wrapAround": true,
  "cellAlign": "left",
  "dragThreshold":"15",
  "draggable": {{ enough_to_wrap }},
  "pauseAutoPlayOnHover": true,
  "prevNextButtons": true,
  "pageDots": false,
  "groupCells": 2,
  "arrowShape": "M71.9,95L25.1,52.2c-0.6-0.6-0.9-1.3-0.9-2.2s0.3-1.6,0.9-2.2L71.9,5l3.9,4.3L31.4,50l44.4,40.7L71.9,95z"
}{% endcapture %}

{{ 'ugc-videos.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<section class="section-{{ section.id }}-padding global__section" data-section-id="{{ section.id }}" data-section-type="carousel">
  <div class="ugc-main__container">
    {% if section.settings.heading != blank %}
      <div class="grid__wrapper">
        <div class="span-12 auto a-center mb5">
          <h2 class="ugc-heading">{{ section.settings.heading }}</h2>
        </div>
      </div>
    {% endif %}

    <div class="grid__wrapper">
      <div class="ugc-videos--blocks js-carousel span-12 auto" data-flickity='{{ carousel_config }}'>
        {%- for block in section.blocks -%}
          {%- if block.settings.video != blank or block.settings.image != blank -%}
            <div class="ugc-video-slide">
              <div class="ugc-video--block">
                {%- if block.settings.video != blank -%}
                  {{
                    block.settings.video
                    | video_tag:
                      image_size: '500x',
                      autoplay: true,
                      loop: true,
                      controls: false,
                      muted: true,
                      class: 'ugc-video'
                  }}
                  <button class="ugc-mute-toggle" aria-label="Mute toggle">
                    <span class="icon-muted">
                      {% render 'snip-icons',
                        type: 'apollo',
                        icon: 'volume-mute',
                        classes: 'ugc-audio-icon',
                        size: '18px',
                        fill: 'white',
                        hover: 'white'
                      %}
                    </span>
                    <span class="icon-unmuted hidden">
                      {% render 'snip-icons',
                        type: 'apollo',
                        icon: 'volume-1',
                        classes: 'ugc-audio-icon',
                        size: '18px',
                        fill: 'white',
                        hover: 'white'
                      %}
                    </span>
                  </button>
                {%- elsif block.settings.image != blank -%}
                  <img
                    src="{{ block.settings.image | image_url: width: 500 }}"
                    alt="{{ block.settings.image.alt | escape }}"
                    loading="lazy"
                    class="ugc-video"
                  >
                {%- endif -%}
              </div>

              {% if block.settings.product != blank %}
                <div class="ugc-product--block">
                  <a href="{{ block.settings.product.url }}" class="ugc-product-link">
                    <div class="ugc-product-card-inner">
                      <div class="ugc-product--image">
                        <img
                          src="{{ block.settings.product.featured_image | image_url: width: 100 }}"
                          alt="{{ block.settings.product.featured_image.alt | escape }}"
                          width="50"
                          height="50"
                          loading="lazy"
                        >
                      </div>
                      <div class="ugc-product-details">
                        <div class="ugc-product-title">{{ block.settings.product.title | truncate: 20 }}</div>
                        <div class="ugc-product-price">
                          {{ block.settings.product.price | money }}
                        </div>
                      </div>

                      {%- liquid
                        if routes.root_url == '/'
                          assign product_url = '/products/' | append: block.settings.product.handle | append: '?section_id=quickshop'
                        else
                          assign product_url = routes.root_url | append: '/products/' | append: block.settings.product.handle | append: '?section_id=quickshop'
                        endif

                        assign has_model = false
                        assign has_video = false
                        for media in block.settings.product.media
                          if media.media_type == "video" or media.media_type == "external_video"
                            assign has_video = true
                            continue
                          endif
                          if media.media_type == "model"
                            assign has_model = true
                            continue
                          endif
                        endfor
                      -%}

                      <div class="ugc-view-btn">
                        <button class="ugc-quickview-trigger js-quickview-trigger no-js-hidden"
                          type="button" name="button"
                          aria-label="Quick view {{ block.settings.product.title | escape }}"
                          data-product-url="{{ product_url }}"
                          data-has-model="{{ has_model }}"
                          data-has-video="{{ has_video }}"
                          data-product-pickup-availability="true"
                          data-product-complementary-products="true">
                          {% render 'snip-icons',
                            type: 'theme',
                            icon: 'search',
                            classes: 'ugc-search-icon',
                            size: '14px',
                            fill: 'white',
                            hover: 'white'
                          %}
                        </button>
                      </div>
                    </div>
                  </a>
                </div>
              {% endif %}
            </div>
            {% endif %}
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>
  </div>
</section>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    const videoBlocks = document.querySelectorAll('.ugc-video--block');

    function muteAllVideos() {
      document.querySelectorAll('.ugc-video').forEach(video => {
        video.muted = true;
      });
      document.querySelectorAll('.ugc-mute-toggle').forEach(button => {
        const mutedIcon = button.querySelector('.icon-muted');
        const unmutedIcon = button.querySelector('.icon-unmuted');
        if (mutedIcon && unmutedIcon) {
          mutedIcon.classList.remove('hidden');
          unmutedIcon.classList.add('hidden');
        }
      });
    }

    // initialize and play all videos
    videoBlocks.forEach(block => {
      const video = block.querySelector('.ugc-video');
      if (!video) return;
      video.loop = true;
      video.muted = true;
      video.playsInline = true;
      video.play().catch(e => console.log('Autoplay blocked:', e));
    });

    // mute toggle logic
    videoBlocks.forEach(block => {
      const video = block.querySelector('.ugc-video');
      const button = block.querySelector('.ugc-mute-toggle');
      const mutedIcon = button ? button.querySelector('.icon-muted') : null;
      const unmutedIcon = button ? button.querySelector('.icon-unmuted') : null;

      if (!video || !button) return;

      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        if (video.muted) {
          // Unmuting this video: mute all others first
          muteAllVideos();
          video.muted = false;
          if (mutedIcon && unmutedIcon) {
            mutedIcon.classList.add('hidden');
            unmutedIcon.classList.remove('hidden');
          }
        } else {
          // Muting this video
          video.muted = true;
          if (mutedIcon && unmutedIcon) {
            mutedIcon.classList.remove('hidden');
            unmutedIcon.classList.add('hidden');
          }
        }
      });
    });

    // equal height for product blocks
    function equalizeProductHeights() {
      const productBlocks = document.querySelectorAll('.ugc-main__container .ugc-product--block');
      if (!productBlocks.length) return;

      let maxHeight = 0;

      productBlocks.forEach(el => { el.style.height = 'auto'; });
      productBlocks.forEach(el => {
        const h = el.offsetHeight;
        if (h > maxHeight) maxHeight = h;
      });
      productBlocks.forEach(el => {
        el.style.height = `${maxHeight}px`;
      });
    }

    equalizeProductHeights();

    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(equalizeProductHeights, 200);
    });
  });
</script>

{% schema %}
{
  "name": "UGC Videos",
  "tag": "section",
  "class": "section section-ugc-videos",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Join on Instagram"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "ugc-video",
      "name": "UGC Video Block",
      "settings": [
        {
          "type": "video",
          "id": "video",
          "label": "A Shopify-hosted video"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "UGC Videos"
    }
  ]
}
{% endschema %}
