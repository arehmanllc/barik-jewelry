{%- liquid
  assign enough_to_wrap = false
  if section.blocks.size > 1
    assign enough_to_wrap = true
  endif
-%}

{% capture carousel_config %}{
  "wrapAround": true,
  "cellAlign": "left",
  "dragThreshold":"15",
  "draggable": {{ enough_to_wrap }},
  "pauseAutoPlayOnHover": true,
  "prevNextButtons": true,
  "pageDots": false,
  "groupCells": 2,
  "arrowShape": "M71.9,95L25.1,52.2c-0.6-0.6-0.9-1.3-0.9-2.2s0.3-1.6,0.9-2.2L71.9,5l3.9,4.3L31.4,50l44.4,40.7L71.9,95z"
}{% endcapture %}

{{ 'ugc-videos.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  /* Fallback horizontal alignment while loading */
  [data-section-id="{{ section.id }}"][data-section-loaded="false"] .ugc-videos--blocks {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none; /* Firefox */
  }
  [data-section-id="{{ section.id }}"][data-section-loaded="false"] .ugc-videos--blocks::-webkit-scrollbar {
    display: none; /* Safari and Chrome */
  }
  [data-section-id="{{ section.id }}"][data-section-loaded="false"] .ugc-video-slide {
    flex: 0 0 calc(20% - 20px);
    scroll-snap-align: start;
  }
  @media screen and (max-width: 1024px) {
    [data-section-id="{{ section.id }}"][data-section-loaded="false"] .ugc-video-slide {
      flex: 0 0 calc(33.33% - 15px);
    }
  }
  @media screen and (max-width: 768px) {
    [data-section-id="{{ section.id }}"][data-section-loaded="false"] .ugc-video-slide {
      flex: 0 0 calc(50% - 10px);
    }
  }
{%- endstyle -%}

<section class="section-{{ section.id }}-padding global__section"
  data-section-id="{{ section.id }}"
  data-section-type="carousel"
  data-section-loaded="false"
  data-preload-vendor="{{ 'vendor-flickity.js' | asset_url }}"
  data-asset-url="{{ 'carousel.js' | asset_url }}">
  <div class="ugc-main__container page-width">
    {% if section.settings.heading != blank %}
      <div class="grid__wrapper">
        <div class="span-12 auto a-center mb5">
          <h2 class="section-heading">{{ section.settings.heading | escape }}</h2>
        </div>
      </div>
    {% endif %}

    <div class="ugc-videos--blocks js-carousel" data-flickity='{{ carousel_config }}'>
      {%- for block in section.blocks -%}
        {%- if block.type == 'ugc-video' -%}
          <div class="ugc-video-slide" {{ block.shopify_attributes }}>
            <div class="ugc-video--block">
              {% if block.settings.video != blank %}
                {{
                  block.settings.video
                  | video_tag:
                    image_size: '400x',
                    controls: false,
                    preload: 'metadata',
                    class: 'ugc-video'
                }}
              {% endif %}

              <button class="ugc-mute-toggle" aria-label="Toggle sound">
                <svg class="icon icon-muted" xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 34 34" fill="none">
                  <rect width="34" height="34" rx="10" fill="white" fill-opacity="0.06"/>
                  <path d="M24.8289 15.1943L21.2168 18.8064" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M21.2168 15.1943L24.8289 18.8064" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12.1878 14.5924H10.3817C9.72596 14.5924 9.17773 15.1406 9.17773 15.7964V18.2044C9.17773 18.8602 9.72596 19.4084 10.3817 19.4084H12.1878L16.8955 22.7917C17.6724 23.3293 18.7888 22.7632 18.8098 21.8164V12.1843C18.8324 11.2369 17.7829 10.67 17.0038 11.2091L12.1878 14.5924Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>

                <svg class="icon icon-unmuted hidden" xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 34 34" fill="none">
                  <rect width="34" height="34" rx="10" fill="white" fill-opacity="0.06"/>
                  <path d="M20.1275 14.1061C20.1275 14.1061 21.5088 14.8738 21.5088 16.7199C21.5088 18.3765 20.1657 19.2142 20.1657 19.2142" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M23.0144 13.126C23.0144 13.126 24.9921 14.2252 24.9921 16.8682C24.992 19.2401 23.0691 20.4394 23.0691 20.4394" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M11.395 14.6524H9.58902C8.93324 14.6524 8.38501 15.2006 8.38501 15.8565V18.2645C8.38501 18.9202 8.93324 19.4685 9.58902 19.4685H11.395L16.1027 22.8517C16.8797 23.3893 17.9961 22.8233 18.0171 21.8765V12.2444C18.0397 11.297 16.9902 10.7301 16.2111 11.2691L11.395 14.6524Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>

            {% if block.settings.product != blank %}
              <div class="ugc-product--block">
                <a href="{{ block.settings.product.url }}" class="ugc-product-link">
                  <div class="ugc-product-card-inner">
                    <div class="ugc-product--image">
                      <img
                        src="{{ block.settings.product.featured_image | image_url: width: 100 }}"
                        alt="{{ block.settings.product.featured_image.alt | escape }}"
                        width="50"
                        height="50"
                        loading="lazy"
                      >
                    </div>

                    <div class="ugc-product-details">
                      <div class="ugc-product-title">{{ block.settings.product.title | truncate: 20 }}</div>
                      <div class="ugc-product-price">
                        {{ block.settings.product.price | money }}
                      </div>
                    </div>

                    {%- liquid
                      if routes.root_url == '/'
                        assign product_url = '/products/' | append: block.settings.product.handle | append: '?section_id=quickshop'
                      else
                        assign product_url = routes.root_url | append: '/products/' | append: block.settings.product.handle | append: '?section_id=quickshop'
                      endif

                      assign has_model = false
                      assign has_video = false
                      for media in block.settings.product.media
                        if media.media_type == "video" or media.media_type == "external_video"
                          assign has_video = true
                          continue
                        endif
                        if media.media_type == "model"
                          assign has_model = true
                          continue
                        endif
                      endfor
                    -%}

                    <div class="ugc-view-btn">
                      <button class="ugc-quickview-trigger js-quickview-trigger no-js-hidden"
                        type="button" name="button"
                        aria-label="Quick view {{ block.settings.product.title | escape }}"
                        data-product-url="{{ product_url }}"
                        data-has-model="{{ has_model }}"
                        data-has-video="{{ has_video }}"
                        data-product-pickup-availability="true"
                        data-product-complementary-products="true">
                       <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 34 34" fill="none">
<rect width="34" height="34" rx="10" fill="#242424"/>
<path d="M16.7147 22.1189C19.6988 22.1189 22.1179 19.6998 22.1179 16.7157C22.1179 13.7316 19.6988 11.3125 16.7147 11.3125C13.7306 11.3125 11.3115 13.7316 11.3115 16.7157C11.3115 19.6998 13.7306 22.1189 16.7147 22.1189Z" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M22.6873 22.6878L21.5498 21.5503" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
                      </button>
                    </div>
                  </div>
                </a>
              </div>
            {% endif %}
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>
  </div>
</section>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    const videoBlocks = document.querySelectorAll('.ugc-video--block');

    function muteAllVideos() {
      document.querySelectorAll('.ugc-video').forEach(video => {
        video.muted = true;
      });
      document.querySelectorAll('.ugc-mute-toggle').forEach(button => {
        const mutedIcon = button.querySelector('.icon-muted');
        const unmutedIcon = button.querySelector('.icon-unmuted');
        if (mutedIcon && unmutedIcon) {
          mutedIcon.classList.remove('hidden');
          unmutedIcon.classList.add('hidden');
        }
      });
    }

    // initialize and play all videos
    videoBlocks.forEach(block => {
      const video = block.querySelector('.ugc-video');
      if (!video) return;
      video.loop = true;
      video.muted = true;
      video.playsInline = true;
      video.play().catch(e => console.log('Autoplay blocked:', e));
    });

    // mute toggle logic
    videoBlocks.forEach(block => {
      const video = block.querySelector('.ugc-video');
      const button = block.querySelector('.ugc-mute-toggle');
      const mutedIcon = button ? button.querySelector('.icon-muted') : null;
      const unmutedIcon = button ? button.querySelector('.icon-unmuted') : null;

      if (!video || !button) return;

      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        if (video.muted) {
          // Unmuting this video: mute all others first
          muteAllVideos();
          video.muted = false;
          if (mutedIcon && unmutedIcon) {
            mutedIcon.classList.add('hidden');
            unmutedIcon.classList.remove('hidden');
          }
        } else {
          // Muting this video
          video.muted = true;
          if (mutedIcon && unmutedIcon) {
            mutedIcon.classList.remove('hidden');
            unmutedIcon.classList.add('hidden');
          }
        }
      });
    });

    // equal height for product blocks
    function equalizeProductHeights() {
      const productBlocks = document.querySelectorAll('.ugc-main__container .ugc-product--block');
      if (!productBlocks.length) return;

      let maxHeight = 0;

      productBlocks.forEach(el => { el.style.height = 'auto'; });
      productBlocks.forEach(el => {
        const h = el.offsetHeight;
        if (h > maxHeight) maxHeight = h;
      });
      productBlocks.forEach(el => {
        el.style.height = `${maxHeight}px`;
      });
    }

    equalizeProductHeights();

    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(equalizeProductHeights, 200);
    });
  });
</script>

{% schema %}
{
  "name": "UGC Videos",
  "tag": "section",
  "class": "section section-ugc-videos",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Join on Instagram"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "ugc-video",
      "name": "UGC Video Block",
      "settings": [
        {
          "type": "video",
          "id": "video",
          "label": "A Shopify-hosted video"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "UGC Videos"
    }
  ]
}
{% endschema %}
