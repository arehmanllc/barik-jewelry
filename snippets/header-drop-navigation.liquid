{% comment %}
snippets/header-drop-navigation.liquid
{% endcomment %}

{% comment %}
Liquid logic for navigation
{% endcomment %}
{%- liquid
  assign is_upcase = false

  if settings.nav_transform
    assign is_upcase = true
  endif

-%}
{% if link.levels == 0 %}
  <li class="navigation__menuitem js-doubletap-to-go" role="none">
    <a class="navigation__menulink js-menu-link is_upcase-{{ is_upcase }}" role="menuitem" href="{{ link.url }}">
      {{ link.title }}
    </a>
  </li>
{% elsif link.levels == 1 %}
  <li class="navigation__menuitem navigation__menuitem--dropdown js-menuitem js-doubletap-to-go" role="none">
    <a class="navigation__menulink js-menu-link js-aria-expand js-open-dropdown-on-key is_upcase-{{ is_upcase }}" role="menuitem" aria-haspop="true" aria-expanded="false" href="{{ link.url}}">
      {{ link.title }}
      {% render 'snip-icons',
         wrapper: '.navigation__menulink',
         type: 'apollo',
         icon: 'down-carrot',
         classes: 'navigation__menulink--icon vib-center',
         size: '6px',
         fill: 'var(--nav-color)',
         hover: 'var(--nav-hover-link-color)' %}
    </a>

    <ul class="megamenu row grid__wrapper">
      <span class="span-12 auto megamenu--container">
        <div class="megamenu__wrapper megamenu__wrapper--flex">
          
          <!-- Links Column -->
          <div class="megamenu__links-column">
            <ul class="megamenu__list">
              {% for sub_link in link.links %}
                <li class="megamenu__listitem" data-collection-handle="{{ sub_link.handle }}">
                  <a class="menu__listlink" href="{{ sub_link.url }}" data-collection-index="{{ forloop.index0 }}">
                     {{ sub_link.title }}
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>

          <!-- Image Column -->
          <div class="megamenu__images-column">
            {% for sub_link in link.links %}
              {% if sub_link.type == 'collection_link' %}
                {% assign menu_object = sub_link.object %}
                {% if menu_object == blank or menu_object.image == blank %}
                  {% assign menu_object = collections[sub_link.handle] %}
                {% endif %}

                {% liquid
                   assign featured_image = blank
                   if sub_link.image
                     assign featured_image = sub_link.image
                   elsif menu_object.image
                     assign featured_image = menu_object.image
                   elsif menu_object.featured_image
                     assign featured_image = menu_object.featured_image
                   elsif menu_object.products.first.featured_media.preview_image
                     assign featured_image = menu_object.products.first.featured_media.preview_image
                   endif
                %}

                {% if featured_image %}
                    <div class="megamenu__collection-image-wrapper" data-image-index="{{ forloop.index0 }}">
                      <a class="mb0" href="{{ menu_object.url | default: sub_link.url }}">
                        <div class="megamenu__collection-image">
                          {% render 'helper-image',
                            type: featured_image,
                            sm_render: '400px',
                            md_render: '400px',
                            lg_render: '400px' %}
                        </div>
                      </a>
                    </div>
                {% endif %}
              {% endif %}
            {% endfor %}
          </div>
         
        </div>
      </span>
    </ul>
  </li>
{% elsif link.levels == 2 %}
  {% assign linklist_qty = link.links.size %}
  {% case linklist_qty %}
    {% when 2 %}
      {% assign columns = '2' %}
    {% when 3 %}
      {% assign columns = '3' %}
    {% else %}
      {% assign columns = '4' %}
  {% endcase %}
  <li
    class="navigation__menuitem navigation__menuitem--dropdown js-aria-expand js-doubletap-to-go"
    aria-haspopup="true"
    aria-expanded="false"
    role="none">

    <a
      class="navigation__menulink js-menu-link js-open-dropdown-on-key is_upcase-{{ is_upcase }}"
      href="{{ link.url }}">

      {{ link.title }}

      {%
       render 'snip-icons',
       wrapper: '.navigation__menulink',
       type: 'apollo',
       icon: 'down-carrot',
       classes: 'navigation__menulink--icon vib-center',
       size: '6px',
       fill: 'var(--nav-color)',
       hover: 'var(--nav-hover-link-color)'
      %}

    </a>
    <ul class="megamenu row grid__wrapper">
      <span class="span-12 auto megamenu--container">
        <div class="megamenu__wrapper" style="columns: {{ columns }}">
          {% for sub_link in link.links %}

            {% if sub_link.links != blank %}

              <li class="megamenu__listcontainer span-3 auto">

                {% if sub_link.type == 'collection_link' %}

                  {% assign collection = sub_link.object %}

                  {% if collection.image and section.settings.show_mm_collection_images %}

                    <a class="mb0" href="{{ collection.url }}">
                      <div class="megamenu__collection-image">
                        {%
                          render 'helper-image',
                          type: collection.image,
                          sm_render: '360px',
                          md_render: '360px',
                          lg_render: '360px'
                        %}
                      </div>
                    </a>
                  {% endif %}
                {% endif %}

                <h4 class="megamenu__header">
                  <a class="megamenu__headerlink" href="{{ sub_link.url }}">{{ sub_link.title }}</a>
                </h4>

                <ul class="megamenu__list">
                  {% for sub_sub_link in sub_link.links %}
                    <li class="megamenu__listitem">
                      <a class="menu__listlink" href="{{ sub_sub_link.url }}">
                        {% if sub_sub_link.type == 'product_link' and section.settings.show_product_images %}
                          <span class="menu__listitem-product">
                            {% assign product = sub_sub_link.object %}
                            {% render 'helper-image',
                              type: product.featured_media.preview_image,
                              width: 100,
                              fetchpriority: high %}
                            {{ sub_sub_link.title }}
                          </span>
                        {% elsif sub_sub_link.type == 'collection_link' and section.settings.show_collection_images %}
                          <span class="menu__listitem-collection">
                            {% liquid
                              assign collection = sub_sub_link.object
                              if collection.image
                                assign featured_image = collection.featured_image
                              else
                                assign featured_image = collection.products.first.featured_media.preview_image
                              endif
                            %}
                            {% render 'helper-image',
                              type: featured_image,
                              width: 100,
                              fetchpriority: high %}
                            {{ sub_sub_link.title }}
                          </span>
                        {% else %}
                          {{ sub_sub_link.title }}
                        {% endif %}
                      </a>
                    </li>
                  {% endfor %}
                </ul>
              </li>
            {% endif %}
          {% endfor %}

          <ul class="megamenu__ulcontainer span-3 auto">
            {% for sub_link in link.links %}
              {% if sub_link.links == blank %}
                <li class="megamenu__listitem">
                  <a class="megamenu__listlink" href="{{ sub_link.url }}">
                    {% if sub_link.type == 'product_link' and section.settings.show_product_images %}
                      <span class="menu__listitem-product">
                        {% assign product = sub_link.object %}
                        {% render 'helper-image',
                          type: product.featured_media.preview_image,
                          width: 100,
                          fetchpriority: high %}
                        {{ sub_link.title }}
                      </span>
                    {% elsif sub_link.type == 'collection_link' and section.settings.show_collection_images %}
                      <span class="menu__listitem-collection">
                        {% liquid
                          assign collection = sub_link.object
                          if collection.image
                            assign featured_image = collection.featured_image
                          else
                            assign featured_image = collection.products.first.featured_media.preview_image
                          endif
                        %}
                        {% render 'helper-image',
                          type: featured_image,
                          width: 100,
                          fetchpriority: high %}
                        {{ sub_link.title }}
                      </span>
                    {% else %}
                      {{ sub_link.title }}
                    {% endif %}
                  </a>
                </li>
              {% endif %}
            {% endfor %}
          </ul>
        </div>
      </span>
    </ul>
  </li>
{% endif %}
